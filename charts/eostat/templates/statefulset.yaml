{{- /* Tier-based resource mappings - Single Source of Truth */}}
{{- $resourceTiers := dict
      "light"  (dict "cpu" "2000m"  "memory" "8Gi"   "storage" "10Gi")
      "medium" (dict "cpu" "6000m"  "memory" "24Gi"  "storage" "20Gi")
      "heavy"  (dict "cpu" "10000m" "memory" "48Gi"  "storage" "50Gi")
      "gpu"    (dict "cpu" "8000m"  "memory" "32Gi"  "storage" "50Gi")
    -}}
{{- $tier := .Values.tier | default "medium" -}}
{{- $tierConfig := index $resourceTiers $tier -}}

{{- /* Compute final resources: explicit override or tier-based */}}
{{- $cpuLimit := $tierConfig.cpu -}}
{{- $memLimit := $tierConfig.memory -}}
{{- if and .Values.resources .Values.resources.limits -}}
  {{- $cpuLimit = .Values.resources.limits.cpu | default $tierConfig.cpu -}}
  {{- $memLimit = .Values.resources.limits.memory | default $tierConfig.memory -}}
{{- end -}}

{{- /* Auto-shutdown configuration */}}
{{- $maxDurationHours := .Values.session.maxDurationHours | default 0 -}}
{{- $activeDeadlineSeconds := 0 -}}
{{- if gt $maxDurationHours 0 -}}
  {{- $activeDeadlineSeconds = mul $maxDurationHours 3600 | int -}}
{{- end -}}

{{- $fullName := include "library-chart.fullname" . -}}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "library-chart.fullname" . }}
  labels:
    {{- include "library-chart.labels" . | nindent 4 }}
spec:
{{- if not .Values.autoscaling.enabled }}
  {{- if .Values.global.suspend }}
  replicas: 0
  {{- else }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
{{- end }}
  serviceName: {{ include "library-chart.fullname" . }}
  selector:
    matchLabels:
      {{- include "library-chart.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- if (.Values.git).enabled }}
        checksum/git: {{ include (print $.Template.BasePath "/secret-git.yaml") . | sha256sum }}
        {{- end }}
        {{- if (.Values.s3).enabled }}
        checksum/s3: {{ include (print $.Template.BasePath "/secret-s3.yaml") . | sha256sum }}
        {{- end }}
        {{- if (.Values.vault).enabled }}
        checksum/vault: {{ include (print $.Template.BasePath "/secret-vault.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretHive" .))) }}
        checksum/hive: {{ include (print $.Template.BasePath "/secret-hive.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretMetaflow" .))) }}
        checksum/metaflow: {{ include (print $.Template.BasePath "/secret-metaflow.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretMLFlow" .))) }}
        checksum/mlflow: {{ include (print $.Template.BasePath "/secret-mlflow.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretChromaDB" .))) }}
        checksum/chromadb: {{ include (print $.Template.BasePath "/secret-chromadb.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretMilvus" .))) }}
        checksum/milvus: {{ include (print $.Template.BasePath "/secret-milvus.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretPostgreSQL" .))) }}
        checksum/postgresql: {{ include (print $.Template.BasePath "/secret-postgresql.yaml") . | sha256sum }}
        {{- end }}
        {{- if (include "library-chart.repository.enabled"  .) }}
        checksum/repository: {{ include (print $.Template.BasePath "/configmap-repository.yaml") . | sha256sum }}
        {{- end }}
        {{- if (.Values.certificates).cacerts }}
        checksum/cacerts: {{ .Values.certificates.cacerts | sha256sum }}
        {{- end }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "library-chart.selectorLabels" . | nindent 8 }}
    spec:
      {{- if gt $activeDeadlineSeconds 0 }}
      # Kubernetes-enforced auto-shutdown (tamper-proof)
      # Pod will be terminated after this duration
      activeDeadlineSeconds: {{ $activeDeadlineSeconds }}
      {{- end }}
      # Grace period for saving work before forceful termination
      terminationGracePeriodSeconds: {{ .Values.session.terminationGracePeriodSeconds | default 300 }}
      volumes:
        - name: jupyter-local
          emptyDir: {}
        - name: home
        {{- if (.Values.persistence).enabled }}
          persistentVolumeClaim:
            claimName: {{ .Values.persistence.existingClaim | default (include "library-chart.fullname" .) }}
        {{- else }}
          emptyDir: {}
        {{- end }}
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 10Gi
        - name: config-files
          emptyDir: {}
        {{- if (.Values.discovery).hive }}
        - name: secret-hive
          secret:
            secretName: {{ include "library-chart.secretNameHive" . }}
        {{- end }}
        {{- if (.Values.proxy).enabled }}
        - name: secret-proxy
          secret:
            secretName: {{ include "library-chart.secretNameProxy" . }}
        {{- end }}
        {{- if (.Values.discovery).metaflow }}
        - name: secret-metaflow
          secret:
            secretName: {{ include "library-chart.secretNameMetaflow" . }}
        {{- end }}
        {{- if (.Values.certificates).cacerts }}
        - name: cacerts
          secret:
            secretName: {{ include "library-chart.secretNameCacerts" . }}
        {{- end }}
        {{- if (.Values.userPreferences.aiAssistant).enabled }}
        - name: secret-assistant
          secret:
            secretName: {{ include "library-chart.secretNameAssistantJupyter" . }}
        {{- end }}
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "library-chart.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      subdomain: {{ include "library-chart.fullname" . }}
      hostname: jupyter
      initContainers:
        - name: make-secrets-writable
          image: {{ .Values.service.initContainer.image }}
          imagePullPolicy: {{ .Values.service.initContainer.pullPolicy }}
          command:
            - sh
            - -c
            - |
              echo 'initContainer make-secrets-writable is started';
              {{ if (.Values.userPreferences.aiAssistant).enabled }}
              mkdir /dest/jupyter-ai
              cp /src/jupyter-ai/config.json /dest/jupyter-ai/config.json
              {{- end }}
              {{- if .Values.discovery.hive }}
              mkdir /dest/hive;
              cp /src/hive/hive-site.xml /dest/hive/hive-site.xml;
              {{- end }}
              {{- if .Values.discovery.metaflow }}
              mkdir /dest/metaflow/;
              cp /src/metaflow/config.json /dest/metaflow/config.json;
              {{- end }}
              {{- if and .Values.certificates .Values.certificates.cacerts }}
              mkdir /dest/cacerts;
              {{- if regexMatch "^https?://" .Values.certificates.cacerts }}
              curl -s $(cat /cacerts/ca-certs.url) -o /tmp/ca.pem
              {{- else }}
              cp /cacerts/ca.pem /tmp/ca.pem
              {{- end }}
              awk 'BEGIN {c=0;} /BEGIN CERT/{c++} { print > "/dest/cacerts/cert." c ".crt"}' < /tmp/ca.pem;
              {{- end }}
          volumeMounts:
            {{- if (.Values.userPreferences.aiAssistant).enabled }}
            - name: secret-assistant
              mountPath: /src/jupyter-ai
            {{- end }}
            - name: config-files
              mountPath: /dest
            {{- if (.Values.certificates).cacerts }}
            - name: cacerts
              mountPath: /cacerts
            {{- end }}
            {{- if (.Values.discovery).hive }}
            - name: secret-hive
              mountPath: /src/hive
            {{- end }}
            {{- if (.Values.discovery).metaflow }}
            - name : secret-metaflow
              mountPath: /src/metaflow
            {{- end }}
          resources:
            limits:
              cpu: 50m
              memory: 50Mi
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          {{- if .Values.service.image.custom.enabled }}
          image: "{{ .Values.service.image.custom.version }}"
          {{- else }}
          image: "{{ .Values.service.image.version }}"
          {{- end }}
          command: ["/bin/sh","-c"]
          args: ["{{ .Values.init.standardInitPath }} jupyter lab --no-browser --ip '0.0.0.0' --LabApp.token='$(PASSWORD)' --ContentsManager.allow_hidden=True"]
          imagePullPolicy: {{ .Values.service.image.pullPolicy }}
          {{- if gt $activeDeadlineSeconds 0 }}
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/bash
                  - -c
                  - |
                    echo "[$(date -Iseconds)] Auto-shutdown: Saving work and suspending StatefulSet..." >&2

                    # Create termination marker
                    echo "Session terminated at $(date) due to auto-shutdown" > /home/${PROJECT_USER}/SESSION_ENDED.txt

                    # Attempt to trigger JupyterLab checkpoint save
                    curl -X POST http://localhost:8888/api/contents/checkpoint \
                      -H "Authorization: token ${PASSWORD}" 2>/dev/null || true

                    # Suspend the Helm release to prevent restart loop
                    # This updates global.suspend=true in Helm values
                    # Onyxia UI will see the service as "Suspended"
                    RELEASE_NAME=$(echo $HOSTNAME | sed 's/-[0-9]*$//')

                    # Use helm upgrade to set global.suspend=true
                    helm upgrade "${RELEASE_NAME}" \
                      --reuse-values \
                      --set global.suspend=true \
                      --namespace="${KUBERNETES_NAMESPACE}" \
                      >/dev/null 2>&1 || \
                      echo "Warning: Could not suspend Helm release" >&2

                    sleep 5
          {{- end }}
          env:
            - name: KUBERNETES_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: IMAGE_NAME
              {{- if .Values.service.image.custom.enabled }}
              value: "{{ .Values.service.image.custom.version }}"
              {{- else }}
              value: "{{ .Values.service.image.version }}"
              {{- end }}
            - name: PROJECT_USER
              value: {{ .Values.environment.user }}
            - name: PROJECT_GROUP
              value: {{ .Values.environment.group }}
            - name: ROOT_PROJECT_DIRECTORY
              value: /home/{{ .Values.environment.user }}/work
            - name: WORKSPACE_DIR
              value: /home/{{ .Values.environment.user }}
            # EOStat chapter-specific environment variables
            - name: REPO_URL
              value: {{ .Values.chapter.repository | quote }}
            - name: REPO_BRANCH
              value: {{ .Values.chapter.version | quote }}
            - name: CHAPTER_NAME
              value: {{ .Values.chapter.name | quote }}
            - name: TIER
              value: {{ .Values.tier | quote }}
            - name: KUBERNETES_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            {{- if .Values.init.regionInit }}
            - name: REGION_INIT_SCRIPT
              value: {{ .Values.init.regionInit }}
            {{- end }}
            {{- if .Values.init.personalInit }}
            - name: PERSONAL_INIT_SCRIPT
              value: {{ .Values.init.personalInit }}
            {{- end }}
            {{- if .Values.init.personalInitArgs }}
            - name: PERSONAL_INIT_ARGS
              value: {{ .Values.init.personalInitArgs }}
            {{- end }}
            {{- if .Values.environment.root }}
            - name: GRANT_SUDO
              value: "yes"
            {{- end }}
            {{- if .Values.userPreferences.darkMode }}
            - name: DARK_MODE
              value: "true"
            {{- end }}
            - name: UV_CACHE_DIR
              value: /home/{{ .Values.environment.user }}/work/.cache/uv
            {{- if (.Values.userPreferences.aiAssistant).enabled }}
            - name: OPENAI_API_KEY
              value: {{ .Values.userPreferences.aiAssistant.apiKey }}
            - name: OPENAI_BASE_URL
              value: {{ .Values.userPreferences.aiAssistant.apiBase }}
            - name: ENABLE_JUPYTER_AI_EXTENSION
              value: "{{ .Values.userPreferences.aiAssistant.enabled }}"
            {{- end }}
          envFrom:
            - secretRef:
                name: {{ include "library-chart.secretNameToken" . }}
            {{- if (.Values.git).enabled }}
            - secretRef:
                name: {{ include "library-chart.secretNameGit" . }}
            {{- end }}
            {{- if (.Values.s3).enabled }}
            - secretRef:
                name: {{ include "library-chart.secretNameS3" . }}
            {{- end }}
            {{- if (.Values.vault).enabled }}
            - secretRef:
                name: {{ include "library-chart.secretNameVault" . }}
            {{- end }}
            {{- if (.Values.proxy).enabled }}
            - secretRef:
                name: {{ include "library-chart.secretNameProxy" . }}
            {{- end }}
            {{- if (include "library-chart.repository.enabled"  .) }}
            - configMapRef:
                name: {{ include "library-chart.configMapNameRepository" . }}
            {{- end }}
            {{- if not (empty (trim (include "library-chart.secretMLFlow" .))) }}
            - secretRef:
                name: {{ include "library-chart.secretNameMLFlow" . }}
            {{- end }}
            {{- if not (empty (trim (include "library-chart.secretChromaDB" .))) }}
            - secretRef:
                name: {{ include "library-chart.secretNameChromaDB" . }}
            {{- end }}
            {{- if not (empty (trim (include "library-chart.secretMilvus" .))) }}
            - secretRef:
                name: {{ include "library-chart.secretNameMilvus" . }}
            {{- end }}
            {{- if not (empty (trim (include "library-chart.secretPostgreSQL" .))) }}
            - secretRef:
                name: {{ include "library-chart.secretNamePostgreSQL" . }}
            {{- end }}
            {{- if .Values.extraEnvVars }}
            - secretRef:
                name: {{ include "library-chart.secretNameExtraEnv" . }}
            {{- end }}
          livenessProbe:
            httpGet:
              path: /
              port: {{ .Values.networking.service.port }}
            timeoutSeconds: 2
            failureThreshold: 6
          readinessProbe:
            httpGet:
              path: /
              port: {{ .Values.networking.service.port }}
          {{- if hasKey .Values "startupProbe" }}
          startupProbe:
            httpGet:
              path: /
              port: {{ .Values.networking.service.port }}
            {{- toYaml .Values.startupProbe | nindent 12 }}
          {{- end }}
          resources:
            requests:
              cpu: {{ $cpuLimit }}
              memory: {{ $memLimit }}
            limits:
              cpu: {{ $cpuLimit }}
              memory: {{ $memLimit }}
              {{- if eq $tier "gpu" }}
              nvidia.com/gpu: "1"
              {{- end }}
          volumeMounts:
            - name: jupyter-local
              mountPath: /home/{{ .Values.environment.user }}/.local/share/jupyter
            {{ if (.Values.userPreferences.aiAssistant).enabled }}
            - mountPath: /home/{{ .Values.environment.user }}/.local/share/jupyter/jupyter_ai
              subPath: jupyter-ai
              name: config-files
            {{- end }}
            - mountPath: /home/{{ .Values.environment.user }}/work
              subPath: work
              name: home
            - mountPath: /dev/shm
              name: dshm
            {{- if (.Values.discovery).hive }}
            - name: config-files
              mountPath: /usr/local/lib/hive/conf/hive-site.xml
              subPath: hive/hive-site.xml
            {{- end }}
            {{- if (.Values.discovery).metaflow }}
            - name: config-files
              mountPath: /home/{{ .Values.environment.user }}/.metaflowconfig
              subPath: metaflow
            {{- end }}
            {{- if (.Values.certificates).pathToCaBundle }}
            - name: config-files
              mountPath: {{ .Values.certificates.pathToCaBundle }}
              subPath: cacerts
            {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if eq .Values.tier "gpu" }}
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
      {{- else }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- end }}
