{{- /* Tier-based resource mappings - Single Source of Truth */}}
{{- $resourceTiers := dict
      "light"  (dict "cpu" "2000m"  "memory" "8Gi"   "storage" "10Gi")
      "medium" (dict "cpu" "6000m"  "memory" "24Gi"  "storage" "20Gi")
      "heavy"  (dict "cpu" "10000m" "memory" "48Gi"  "storage" "50Gi")
      "gpu"    (dict "cpu" "8000m"  "memory" "32Gi"  "storage" "50Gi")
    -}}
{{- $tier := .Values.tier | default "medium" -}}
{{- $tierConfig := index $resourceTiers $tier -}}

{{- /* Compute final resources: explicit override or tier-based */}}
{{- $cpuLimit := $tierConfig.cpu -}}
{{- $memLimit := $tierConfig.memory -}}
{{- if and .Values.resources .Values.resources.limits -}}
  {{- $cpuLimit = .Values.resources.limits.cpu | default $tierConfig.cpu -}}
  {{- $memLimit = .Values.resources.limits.memory | default $tierConfig.memory -}}
{{- end -}}

{{- /* Security Profile Configuration */}}
{{- $securityProfile := .Values.securityProfile | default "none" -}}

{{- /* "none" profile uses existing .Values.securityContext (empty by default) */}}
{{- $noneSecurityContext := .Values.securityContext | default dict -}}

{{- /* "baseline" profile: standard hardening */}}
{{- $baselineSecurityContext := dict
      "runAsNonRoot" true
      "runAsUser" 1000
      "allowPrivilegeEscalation" false
      "capabilities" (dict "drop" (list "ALL"))
-}}

{{- /* "restricted" profile: maximum security */}}
{{- $restrictedSecurityContext := dict
      "runAsNonRoot" true
      "runAsUser" 1000
      "allowPrivilegeEscalation" false
      "readOnlyRootFilesystem" true
      "capabilities" (dict "drop" (list "ALL"))
-}}

{{- /* Select effective security context based on profile */}}
{{- $effectiveSecurityContext := $noneSecurityContext -}}
{{- if eq $securityProfile "baseline" -}}
  {{- $effectiveSecurityContext = $baselineSecurityContext -}}
{{- else if eq $securityProfile "restricted" -}}
  {{- $effectiveSecurityContext = $restrictedSecurityContext -}}
{{- end -}}

{{- $fullName := include "library-chart.fullname" . -}}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "library-chart.fullname" . }}
  labels:
    {{- include "library-chart.labels" . | nindent 4 }}
spec:
{{- if not .Values.autoscaling.enabled }}
  {{- if .Values.global.suspend }}
  replicas: 0
  {{- else }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
{{- end }}
  serviceName: {{ include "library-chart.fullname" . }}
  selector:
    matchLabels:
      {{- include "library-chart.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- if (.Values.git).enabled }}
        checksum/git: {{ include (print $.Template.BasePath "/secret-git.yaml") . | sha256sum }}
        {{- end }}
        {{- if (.Values.s3).enabled }}
        checksum/s3: {{ include (print $.Template.BasePath "/secret-s3.yaml") . | sha256sum }}
        {{- end }}
        {{- if (.Values.vault).enabled }}
        checksum/vault: {{ include (print $.Template.BasePath "/secret-vault.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretHive" .))) }}
        checksum/hive: {{ include (print $.Template.BasePath "/secret-hive.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretMetaflow" .))) }}
        checksum/metaflow: {{ include (print $.Template.BasePath "/secret-metaflow.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretMLFlow" .))) }}
        checksum/mlflow: {{ include (print $.Template.BasePath "/secret-mlflow.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretChromaDB" .))) }}
        checksum/chromadb: {{ include (print $.Template.BasePath "/secret-chromadb.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretMilvus" .))) }}
        checksum/milvus: {{ include (print $.Template.BasePath "/secret-milvus.yaml") . | sha256sum }}
        {{- end }}
        {{- if not (empty (trim (include "library-chart.secretPostgreSQL" .))) }}
        checksum/postgresql: {{ include (print $.Template.BasePath "/secret-postgresql.yaml") . | sha256sum }}
        {{- end }}
        {{- if (include "library-chart.repository.enabled"  .) }}
        checksum/repository: {{ include (print $.Template.BasePath "/configmap-repository.yaml") . | sha256sum }}
        {{- end }}
        {{- if (.Values.certificates).cacerts }}
        checksum/cacerts: {{ .Values.certificates.cacerts | sha256sum }}
        {{- end }}
        {{- if (.Values.oidc).enabled }}
        checksum/oidc: {{ include (print $.Template.BasePath "/secret-oidc.yaml") . | sha256sum }}
        checksum/oidc-allowed-users: {{ include (print $.Template.BasePath "/configmap-oidc-allowed-users.yaml") . | sha256sum }}
        {{- end }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "library-chart.selectorLabels" . | nindent 8 }}
    spec:
      volumes:
        - name: rstudio-local
          emptyDir: {}
        - name: home
        {{- if (.Values.persistence).enabled }}
          persistentVolumeClaim:
            claimName: {{ .Values.persistence.existingClaim | default (include "library-chart.fullname" .) }}
        {{- else }}
          emptyDir: {}
        {{- end }}
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 10Gi
        - name: config-files
          emptyDir: {}
        {{- if (.Values.discovery).hive }}
        - name: secret-hive
          secret:
            secretName: {{ include "library-chart.secretNameHive" . }}
        {{- end }}
        {{- if (.Values.proxy).enabled }}
        - name: secret-proxy
          secret:
            secretName: {{ include "library-chart.secretNameProxy" . }}
        {{- end }}
        {{- if (.Values.discovery).metaflow }}
        - name: secret-metaflow
          secret:
            secretName: {{ include "library-chart.secretNameMetaflow" . }}
        {{- end }}
        {{- if (.Values.certificates).cacerts }}
        - name: cacerts
          secret:
            secretName: {{ include "library-chart.secretNameCacerts" . }}
        {{- end }}
        {{- /* Additional volumes for restricted security profile */}}
        {{- if eq $securityProfile "restricted" }}
        - name: tmp
          emptyDir: {}
        - name: var-tmp
          emptyDir: {}
        - name: var-run-rstudio
          emptyDir: {}
        - name: var-lib-rstudio
          emptyDir: {}
        - name: var-log
          emptyDir: {}
        - name: r-user-library
          emptyDir: {}
        - name: user-cache
          emptyDir: {}
        {{- end }}
        {{- if (.Values.oidc).enabled }}
        - name: oidc-allowed-users
          configMap:
            name: {{ include "library-chart.fullname" . }}-oidc-allowed-users
        {{- end }}
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "library-chart.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      subdomain: {{ include "library-chart.fullname" . }}
      hostname: rstudio
      initContainers:
        - name: make-secrets-writable
          image: {{ .Values.service.initContainer.image }}
          imagePullPolicy: {{ .Values.service.initContainer.pullPolicy }}
          command:
            - sh
            - -c
            - |
              echo 'initContainer make-secrets-writable is started';
              {{- if .Values.discovery.hive }}
              mkdir /dest/hive;
              cp /src/hive/hive-site.xml /dest/hive/hive-site.xml;
              {{- end }}
              {{- if .Values.discovery.metaflow }}
              mkdir /dest/metaflow/;
              cp /src/metaflow/config.json /dest/metaflow/config.json;
              {{- end }}
              {{- if and .Values.certificates .Values.certificates.cacerts }}
              mkdir /dest/cacerts;
              {{- if regexMatch "^https?://" .Values.certificates.cacerts }}
              curl -s $(cat /cacerts/ca-certs.url) -o /tmp/ca.pem
              {{- else }}
              cp /cacerts/ca.pem /tmp/ca.pem
              {{- end }}
              awk 'BEGIN {c=0;} /BEGIN CERT/{c++} { print > "/dest/cacerts/cert." c ".crt"}' < /tmp/ca.pem;
              {{- end }}
          volumeMounts:
            - name: config-files
              mountPath: /dest
            {{- if (.Values.certificates).cacerts }}
            - name: cacerts
              mountPath: /cacerts
            {{- end }}
            {{- if (.Values.discovery).hive }}
            - name: secret-hive
              mountPath: /src/hive
            {{- end }}
            {{- if (.Values.discovery).metaflow }}
            - name : secret-metaflow
              mountPath: /src/metaflow
            {{- end }}
          resources:
            limits:
              cpu: 50m
              memory: 50Mi
          {{- if $effectiveSecurityContext }}
          securityContext:
            {{- toYaml $effectiveSecurityContext | nindent 12 }}
          {{- end }}
      containers:
        - name: {{ .Chart.Name }}
          {{- if $effectiveSecurityContext }}
          securityContext:
            {{- toYaml $effectiveSecurityContext | nindent 12 }}
          {{- end }}
          {{- if .Values.service.image.custom.enabled }}
          image: "{{ .Values.service.image.custom.version }}"
          {{- else }}
          image: "{{ .Values.service.image.version }}"
          {{- end }}
          command: ["/bin/sh","-c"]
          args: ["{{ .Values.init.standardInitPath }} /init"]
          imagePullPolicy: {{ .Values.service.image.pullPolicy }}
          env:
            - name: KUBERNETES_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: IMAGE_NAME
              {{- if .Values.service.image.custom.enabled }}
              value: "{{ .Values.service.image.custom.version }}"
              {{- else }}
              value: "{{ .Values.service.image.version }}"
              {{- end }}
            - name: PROJECT_USER
              value: {{ .Values.environment.user }}
            - name: PROJECT_GROUP
              value: {{ .Values.environment.group }}
            - name: ROOT_PROJECT_DIRECTORY
              value: /home/{{ .Values.environment.user }}/work
            - name: WORKSPACE_DIR
              value: /home/{{ .Values.environment.user }}
            # EOStat chapter-specific environment variables
            - name: REPO_URL
              value: {{ .Values.chapter.repository | quote }}
            - name: REPO_BRANCH
              value: {{ .Values.chapter.version | quote }}
            - name: CHAPTER_NAME
              value: {{ .Values.chapter.name | quote }}
            - name: TIER
              value: {{ .Values.tier | quote }}
            {{- if .Values.init.regionInit }}
            - name: REGION_INIT_SCRIPT
              value: {{ .Values.init.regionInit }}
            {{- end }}
            {{- if .Values.init.personalInit }}
            - name: PERSONAL_INIT_SCRIPT
              value: {{ .Values.init.personalInit }}
            {{- end }}
            {{- if .Values.init.personalInitArgs }}
            - name: PERSONAL_INIT_ARGS
              value: {{ .Values.init.personalInitArgs }}
            {{- end }}
            {{- if .Values.environment.root }}
            - name: GRANT_SUDO
              value: "yes"
            {{- end }}
            {{- if (.Values.oidc).enabled }}
            - name: DISABLE_AUTH
              value: "true"
            {{- end }}
          envFrom:
            - secretRef:
                name: {{ include "library-chart.secretNameToken" . }}
            {{- if (.Values.git).enabled }}
            - secretRef:
                name: {{ include "library-chart.secretNameGit" . }}
            {{- end }}
            {{- if (.Values.s3).enabled }}
            - secretRef:
                name: {{ include "library-chart.secretNameS3" . }}
            {{- end }}
            {{- if (.Values.vault).enabled }}
            - secretRef:
                name: {{ include "library-chart.secretNameVault" . }}
            {{- end }}
            {{- if (.Values.proxy).enabled }}
            - secretRef:
                name: {{ include "library-chart.secretNameProxy" . }}
            {{- end }}
            {{- if (include "library-chart.repository.enabled"  .) }}
            - configMapRef:
                name: {{ include "library-chart.configMapNameRepository" . }}
            {{- end }}
            {{- if not (empty (trim (include "library-chart.secretMLFlow" .))) }}
            - secretRef:
                name: {{ include "library-chart.secretNameMLFlow" . }}
            {{- end }}
            {{- if not (empty (trim (include "library-chart.secretChromaDB" .))) }}
            - secretRef:
                name: {{ include "library-chart.secretNameChromaDB" . }}
            {{- end }}
            {{- if not (empty (trim (include "library-chart.secretMilvus" .))) }}
            - secretRef:
                name: {{ include "library-chart.secretNameMilvus" . }}
            {{- end }}
            {{- if not (empty (trim (include "library-chart.secretPostgreSQL" .))) }}
            - secretRef:
                name: {{ include "library-chart.secretNamePostgreSQL" . }}
            {{- end }}
            {{- if .Values.extraEnvVars }}
            - secretRef:
                name: {{ include "library-chart.secretNameExtraEnv" . }}
            {{- end }}
          livenessProbe:
            httpGet:
              path: /
              port: {{ .Values.networking.service.port }}
            timeoutSeconds: 2
            failureThreshold: 6
          readinessProbe:
            httpGet:
              path: /
              port: {{ .Values.networking.service.port }}
          {{- if hasKey .Values "startupProbe" }}
          startupProbe:
            httpGet:
              path: /
              port: {{ .Values.networking.service.port }}
            {{- toYaml .Values.startupProbe | nindent 12 }}
          {{- end }}
          resources:
            requests:
              cpu: {{ $cpuLimit }}
              memory: {{ $memLimit }}
            limits:
              cpu: {{ $cpuLimit }}
              memory: {{ $memLimit }}
              {{- if eq $tier "gpu" }}
              nvidia.com/gpu: "1"
              {{- end }}
          volumeMounts:
            - name: rstudio-local
              mountPath: /home/{{ .Values.environment.user }}/.config/rstudio
            - mountPath: /home/{{ .Values.environment.user }}/work
              subPath: work
              name: home
            - mountPath: /dev/shm
              name: dshm
            {{- if (.Values.discovery).hive }}
            - name: config-files
              mountPath: /usr/local/lib/hive/conf/hive-site.xml
              subPath: hive/hive-site.xml
            {{- end }}
            {{- if (.Values.discovery).metaflow }}
            - name: config-files
              mountPath: /home/{{ .Values.environment.user }}/.metaflowconfig
              subPath: metaflow
            {{- end }}
            {{- if (.Values.certificates).pathToCaBundle }}
            - name: config-files
              mountPath: {{ .Values.certificates.pathToCaBundle }}
              subPath: cacerts
            {{- end }}
            {{- /* Additional volumeMounts for restricted security profile */}}
            {{- if eq $securityProfile "restricted" }}
            - name: tmp
              mountPath: /tmp
            - name: var-tmp
              mountPath: /var/tmp
            - name: var-run-rstudio
              mountPath: /var/run/rstudio-server
            - name: var-lib-rstudio
              mountPath: /var/lib/rstudio-server
            - name: var-log
              mountPath: /var/log
            - name: r-user-library
              mountPath: /home/{{ .Values.environment.user }}/R
            - name: user-cache
              mountPath: /home/{{ .Values.environment.user }}/.cache
            {{- end }}
        {{- if (.Values.oidc).enabled }}
        - name: oauth2-proxy
          image: {{ .Values.oidc.image }}
          imagePullPolicy: {{ .Values.oidc.imagePullPolicy }}
          args:
            - --http-address=0.0.0.0:4180
            - --upstream=http://localhost:8787
            - --provider={{ .Values.oidc.provider }}
            - --oidc-issuer-url={{ .Values.oidc.issuerUrl }}
            - --client-id={{ .Values.oidc.clientId }}
            - --client-secret=
            - --code-challenge-method=S256
            - --cookie-name={{ .Values.oidc.cookieName }}
            - --cookie-secure={{ .Values.oidc.cookieSecure }}
            - --cookie-expire=12h
            - --cookie-refresh=1h
            - --email-domain=*
            - --skip-provider-button=true
            - --reverse-proxy=true
            - --silence-ping-logging=true
            - --oidc-email-claim=url_safe_handle
            - --authenticated-emails-file=/etc/oauth2-proxy/allowed-users.txt
            {{- range .Values.oidc.extraArgs }}
            - {{ . }}
            {{- end }}
          env:
            - name: OAUTH2_PROXY_REDIRECT_URL
              value: "https://{{ .Values.ingress.hostname }}/oauth2/callback"
            - name: OAUTH2_PROXY_COOKIE_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ include "library-chart.fullname" . }}-oidc
                  key: OAUTH2_PROXY_COOKIE_SECRET
            - name: OAUTH2_PROXY_PASS_ACCESS_TOKEN
              value: "true"
            - name: OAUTH2_PROXY_SET_XAUTHREQUEST
              value: "true"
          volumeMounts:
            - name: oidc-allowed-users
              mountPath: /etc/oauth2-proxy
              readOnly: true
          ports:
            - name: oauth2-proxy
              containerPort: 4180
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /ping
              port: 4180
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ping
              port: 4180
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            {{- toYaml .Values.oidc.resources | nindent 12 }}
          {{- if $effectiveSecurityContext }}
          securityContext:
            {{- toYaml $effectiveSecurityContext | nindent 12 }}
          {{- end }}
        {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if eq .Values.tier "gpu" }}
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
      {{- else }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- end }}
